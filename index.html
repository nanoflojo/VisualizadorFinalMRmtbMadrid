<!DOCTYPE html>
<html lang="Spanish">
    <head>
        <meta http-equiv="Content-Type" content="text/html" charset="utf-8">
		<meta name="robots" content="index,follow" />
		<meta name="description" content="Mapa interactivo para visualizar rutas MTB en Madrid, con complementos como Prug, fuentes, sendas verdes, parques naturales..."/>
		<meta name="keywords" content="mapa, rutas, MTB, BTT, Madrid, Prug, fuentes, sendas verdes, bici, bicicleta, montaña, ciclismo, tracks"/>
		<meta name="author" content="Nano Flojo" />
		<meta name="copyright" content="https://maparutasmtb.blogspot.com.es/" />
		<meta name="robots" content="index,follow" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximumscale=1.0, user-scalable=no" />
    <title>Visualizador de rutas MTB</title>
<link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css">
        		<link href='https://rawgit.com/sookoll/ol3-layerswitcher/master/src/ol3-layerswitcher.css' rel='stylesheet'/>
				        <link rel="stylesheet" href="https://unpkg.com/ol-popup@4.0.0/src/ol-popup.css" /> 
    				                <link href="https://unpkg.com/ol-geocoder/dist/ol-geocoder.min.css" rel="stylesheet">
									   <style>
#map {
		width:100%;
		height:800px;
		    border: solid 5px silver; 
    border-radius:5px;
}
      .layer-switcher button {
        width: 50px;
        height: 25px;
        background-image: url('https://raw.githubusercontent.com/nanoflojo/MaparutasMTB/master/BotonMapas.png');
        background-color: rgba(0,60,136,.5);
        background-position: 2px;          
      }
          .layer-switcher .panel {
    border: 4px solid #33607F;
    border-radius: 10px;
    font-size: small;

}
          .ol-rotate {
        top: 10em;
      }
               #map .ol-zoom .ol-zoom-out {
        margin-top: 204px;
      }
      #map .ol-zoomslider {
        background-color: transparent;
        top: 2.3em;
      }

      #map .ol-touch .ol-zoom .ol-zoom-out {
        margin-top: 212px; 
      }
      #map .ol-touch .ol-zoomslider {
        top: 2.75em;
      }

      #map .ol-zoom-in.ol-has-tooltip:hover [role=tooltip],
      #map .ol-zoom-in.ol-has-tooltip:focus [role=tooltip] {
        top: 3px;
      }

      #map .ol-zoom-out.ol-has-tooltip:hover [role=tooltip],
      #map .ol-zoom-out.ol-has-tooltip:focus [role=tooltip] {
        top: 232px;
      }
      .ol-scale-line {
        margin-left: 2.5em;
        bottom: 0.6em;
      }
		.ol-mouse-position{
		position: absolute;
    top: 0.5em;
    margin-right: 3em;
		color: #000000;
    background-color: rgba(255,255,255, 0.5);
    top: 0.5em;
    margin-right: 3em;
    border: solid 3px rgba(173,217,239, 0.7);
    font-size:12px;
		}
          .ol-popup {
    border: 3px solid #5a7ba6;
    border-radius: 10px 10px 10px 10px;
}
      .ol-popup-closer {
    border-radius: 5px 5px 5px 5px;
    border: 1px solid #5a7ba6;
    font-size: 100%;
}
          .ol-geocoder.gcd-gl-container {
    top: 270px;
}
.ol-geocoder .gcd-gl-control{
  height:31.4px;
  width:31.4px
  }
.ol-geocoder .gcd-gl-expanded{
  height:2em;
  width:15.625em
  }
      .ol-geocoder .gcd-gl-btn {
    height: 25.08px;
    width: 25.08px
}
      .boton-pan-center {
      bottom: 0.5em;
      left: 0.5em;
      }
      .botonLeyenda {
      bottom: 2.5em;
      left: 0.5em;
      }
.ventana {
position: absolute;
left: 1em;
top: 5em;

opacity: 0;
visibility: hidden;
transform: scale(1.1);
transition: visibility 0s linear 0.25s, opacity 0.25s 0s, transform 0.25s;
}

.contenido-ventana {
position: absolute;
top: 50%; left: 50%
transform: translate(-50%, -50%);
border: 3px solid #5a7ba6;
background-color: white;
padding: 0.5rem 0.5rem;
width: auto;
border-radius: 0.5rem;
}

.boton-cerrar {
float: right;
width: 1.5rem;
line-height: 1.5rem;
text-align: center;
font-size: 40px;
color: white;
cursor: pointer;
color: #369;
border: 3px solid #5a7ba6;
border-radius: 0.25rem;
background-color: lightgray;

}
  
.boton-cerrar:hover {
background-color: darkgray;
}

.mostrar-ventana {
opacity: 1;
visibility: visible;
transform: scale(1.0);
transition: visibility 0s linear 0s, opacity 0.25s 0s, transform 0.25s;
}
        </style>
  </head>
  <body>
        <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
<script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
        <script src="https://rawgit.com/sookoll/ol3-layerswitcher/master/src/ol3-layerswitcher.js"></script>
		       <script src="https://unpkg.com/ol-popup@4.0.0"></script>
    		       <script src="https://unpkg.com/ol-geocoder"></script>
    		       <div align="left"><a target="_blank" href="http://maparutasmtb.blogspot.com.es/"><img src="https://raw.githubusercontent.com/nanoflojo/MaparutasMTB/master/MapaRutasMTBBaja.jpg" height="36" align="middle" /></a>&nbsp;&nbsp;&nbsp;
				   <font size="+1", align="middle"><b>Visualizador de Rutas</b></font> &nbsp; Arrastra y suelta tu ruta dentro del mapa para poder visualizarla (GPX, KML), o selecciona con el botón (Solo GPX):</div>
<input type="file" id="files" name="files[]" multiple />
        <div id="map" class="map"></div>
        		<div id="info"></div>
<div class="ventana">
<div class="contenido-ventana">
<span class="boton-cerrar">&times;</span>
		<h3>Leyenda</h3>
		<p><h5>Parque Nacional de la Sierra de  Guadarrama</h5></p>
    <img src="https://idecyl.jcyl.es/geoserver/am/ows?service=WMS&request=GetLegendGraphic&format=image/png&width=10&height=10&layer=am:ren_cyl_pnsg_zonific&"/>
<div style="line-height:1px;"><font size=2; color=#000;><img src="https://idecyl.jcyl.es/geoserver/am/ows?service=WMS&request=GetLegendGraphic&format=image/png&width=10&height10&layer=am:ren_cyl_pnsg_actvs_vias_cicl& "/>&nbsp; Vías Ciclistas</font></div>
<br />
<p><img src="https://wms.mapama.gob.es/sig/Biodiversidad/ENP/Leyenda/ENP.png?"/></p>
<p><img src="https://raw.githubusercontent.com/nanoflojo/MaparutasMTB/master/Leyenda.png"/>
		</p>
<p><img src="https://wms.mapama.gob.es/sig/Biodiversidad/MFE/Leyenda/MFE.png?"/>
		</p>
</div>
</div>

    <script>
          /****Load Local File****/
    var gpxFormat = new ol.format.GPX();
	var gpxFeatures;
	function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object

    // files is a FileList of File objects. List some properties.
    var output = [];
    for (var i = 0, f; f = files[i]; i++) {
    console.log("files[i]",files[i]);
    var reader = new FileReader();
    reader.readAsText(files[i], "UTF-8");
    reader.onload = function (evt) {
       console.log(evt.target.result);
       gpxFeatures = gpxFormat.readFeatures(evt.target.result,{
       dataProjection:'EPSG:4326',
       featureProjection:'EPSG:3857'
       });
       gpxLayer.getSource().addFeatures(gpxFeatures);
      console.log("gpxFeatures",gpxFeatures);
      var extent = gpxLayer.getSource().getExtent();     map.getView().fit(extent, map.getSize());
       console.log("gpxFeatures",gpxFeatures)
      }
    }
document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
  }
    var styleWater = new ol.style.Style({
        image: new ol.style.Icon ({src: 'https://raw.githubusercontent.com/nanoflojo/MaparutasMTB/master/gotadeagua4_24.png'}),
        });
	
	var defaultStyle = {
        'Point': new ol.style.Style({
          image: new ol.style.Icon ({src: 'https://raw.githubusercontent.com/nanoflojo/MaparutasMTB/master/Red_flag_OK_24.png'})
        }),
        'MultiLineString': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: '#FF8B01',
            width: 3
          })
        }),
      };

      var styleFunction = function(feature, resolution) {
        var featureStyleFunction = feature.getStyleFunction();
        if (featureStyleFunction) {
          return featureStyleFunction.call(feature, resolution);
        } else {
          return defaultStyle[feature.getGeometry().getType()];
        }
      };
/** Local GPX layer    ****/
    var gpxLayer = new ol.layer.Vector({
        source: new ol.source.Vector({
        }),
        style: styleFunction
    });
    /*** Drag&Drop***/
      var dragAndDropInteraction = new ol.interaction.DragAndDrop({
        formatConstructors: [
          ol.format.GPX,
          ol.format.GeoJSON,
          ol.format.IGC,
          ol.format.KML,
          ol.format.TopoJSON
        ]
      });
    var projection_PNOA = ol.proj.get('EPSG:3857');
    var projectionExtent_PNOA = projection_PNOA.getExtent();
    var size_PNOA = ol.extent.getWidth(projectionExtent_PNOA) / 256;
    var resolutions_PNOA = new Array(20);
    var matrixIds_PNOA = new Array(20);
    for (var z = 0; z < 20; ++z) {
        resolutions_PNOA[z] = size_PNOA / Math.pow(2, z);
        matrixIds_PNOA[z] = z;
    }

      var view = new ol.View({
          center: ol.proj.fromLonLat([-3.9500000, 39.7000000]),
          zoom: 6.7
    });
    var sourceFeatures = new ol.source.Vector(),
    layerFeatures = new ol.layer.Vector({source: sourceFeatures});
		var map = new ol.Map({
          interactions: ol.interaction.defaults().extend([dragAndDropInteraction]),
          target: document.getElementById('map'),
    renderer: 'canvas',
		  layers: [
                new ol.layer.Group({
          'title': 'Mapas',
          layers: [
                        new ol.layer.Tile({
              source: new ol.source.TileWMS(({
                preload: 4,
                url: "http://www.ign.es/wms-inspire/mapa-raster",
                attributions: '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> CC BY 4.0 <a href="http://www.scne.es/">SCNE</a>',
                params: {
                  "LAYERS": "fondo",
                  "TILED": "true",
                  "VERSION": "1.3.0"},
              })),
              title: "Fondo MD Elevaciones",
              type: 'base',
              visible: false,
              opacity: 1.000000,
            }),
            new ol.layer.Tile({
              title: 'Esri Streets',
              opacity: 1.000000,
              type: 'base',
              visible: false,
              source: new ol.source.XYZ({
                attributions: '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> Tiles © <a target="_blank" href="https://www.esri.com/es-es/arcgis/products/arcgis-online/overview">ArcGIS</a> Powered by <a target="_blank" href="https://www.esri.com/es-es/home/">ESRI</a>',
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}'
              })
            }),
            new ol.layer.Tile({
              title: 'Esri Topo',
              opacity: 1.000000,
              type: 'base',
              visible: false,
              source: new ol.source.XYZ({
                attributions: '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> Tiles © <a target="_blank" href="https://www.esri.com/es-es/arcgis/products/arcgis-online/overview">ArcGIS</a> Powered by <a target="_blank" href="https://www.esri.com/es-es/home/">ESRI</a>',
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/' +
                  'World_Topo_Map/MapServer/tile/{z}/{y}/{x}'
              })
            }),
            new ol.layer.Tile({
              title: 'Terrain Stamen',
              type: 'base',
              visible: false,
              source: new ol.source.Stamen({
                layer: 'terrain'
              })
            }),
            new ol.layer.Tile({
              title: 'Mapa transporte público',
              type: 'base',
              visible: false,
              source: new ol.source.XYZ({
                attributions: [
                  'CC-BY-SA © <a target="_blank" href="https://memomaps.de/en/homepage/">MeMoMaps</a>',
                  ol.source.OSM.ATTRIBUTION
                ],
                url: 'http://tileserver.memomaps.de/tilegen/{z}/{x}/{y}.png'
              })
            }),
            new ol.layer.Tile({
            'title': 'OpenTopoMap',
            'type': 'base',
            'visible': 'false',
            'opacity': 1.000000,
            source: new ol.source.XYZ({
    attributions: [
                  '<a target="_blank" href="https://openlayers.org/">OpenLayers</a>  ©  <a target="_blank" href="https://opentopomap.org/#map=5/49.000/10.000">OpenTopoMap</a> CC-BY-SA',
                  ol.source.OSM.ATTRIBUTION
                ],
                url: 'http://c.tile.opentopomap.org/{z}/{x}/{y}.png'
            })
        }),
		 new ol.layer.Tile({
        source: new ol.source.TileWMS(({
          url: "http://wms-defensa.idee.es/mapas",
    attributions: '<a target="_blank" href="http://www.ejercito.mde.es/unidades/Madrid/ceget/index.html">© Ministerio de Defensa CEGET</a>',
          params: {
           "LAYERS": "CEGET_M7814",
           "TILED": "true",
           "VERSION": "1.3.0"},
             })),
          title: "CEGET 1:50.000",
          type: 'base',
          visible: false,
          opacity: 1.000000,
    }),
     new ol.layer.Tile({
        source: new ol.source.TileWMS(({
        url: "http://wms-defensa.idee.es/mapas",
    attributions: '<a target="_blank" href="http://www.ejercito.mde.es/unidades/Madrid/ceget/index.html">© Ministerio de Defensa CEGET</a>',
        params: {
			"LAYERS": "ceget_M682",
			"TILED": "true",
			"VERSION": "1.3.0"},
			})),
        title: "CEGET 1:100.000",
        type: 'base',
        visible: false,
        opacity: 1.000000,
    }),
     new ol.layer.Tile({
        source: new ol.source.TileWMS(({
        url: "http://www.ign.es/wms/primera-edicion-mtn",
		attributions: '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> Teselas cartográficas cedidas por © <a target="_blank" href="https://www.ign.es/web/ign/portal">Instituto Geográfico Nacional de España</a>',
        params: {
			"LAYERS": "MTN25",
			"TILED": "true",
			"VERSION": "1.3.0"},
      })),
        title: "1ª edición MTN25 (1975)",
        type: 'base',
        visible: false,
        opacity: 1.000000,
   }),
   new ol.layer.Tile({
        source: new ol.source.TileWMS(({
        url: "http://www.ign.es/wms/primera-edicion-mtn",
		attributions: '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> Teselas cartográficas cedidas por © <a target="_blank" href="https://www.ign.es/web/ign/portal">Instituto Geográfico Nacional de España</a>',
        params: {
            "LAYERS": "catastrones",
            "TILED": "true",
            "VERSION": "1.3.0"},
      })),
        title: "Minutas MTN50 (1915-1960)",
        type: 'base',
        visible: false,
        opacity: 1.000000,
   }),
	new ol.layer.Tile({
        source: new ol.source.TileWMS(({
        url: "http://www.ign.es/wms/primera-edicion-mtn",
        attributions: '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> Teselas cartográficas cedidas por © <a target="_blank" href="https://www.ign.es/web/ign/portal">Instituto Geográfico Nacional de España</a>',
        params: {
            "LAYERS": "MTN50",
            "TILED": "true",
            "VERSION": "1.3.0"},
       })),
        title: "1ª edición MTN50 (1875)",
        type: 'base',
        visible: false,
        opacity: 1.000000,
    }),
        	new ol.layer.Tile({
        source: new ol.source.TileWMS(({
        url: "http://www.ign.es/wms/minutas-cartograficas",
		attributions: '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> Minutas cartográficas cedidas por © <a target="_blank" href="https://www.ign.es/web/ign/portal">Instituto Geográfico Nacional de España</a>',
        params: {
            "LAYERS": "Minutas",
            "TILED": "true",
            "VERSION": "1.3.0"},
      })),
        title: "Minutas Cartográficas (1870)",
		    visible: false,
        type: 'base',
        opacity: 1.000000,
   }),
     new ol.layer.Tile({
       source: new ol.source.TileWMS(({
         url: "http://www.ign.es/wms/hojas-kilometricas",
         attributions: '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> Minutas cartográficas cedidas por © <a target="_blank" href="https://www.ign.es/web/ign/portal">Instituto Geográfico Nacional de España</a>',
         params: {
           "LAYERS": "Mapas",
           "TILED": "true",
           "VERSION": "1.3.0"
         },
       })),
       title: "Hojas Kilométricas (1860)",
       type: 'base',
       visible: false,
       opacity: 1.000000,
     }),  
     			          new ol.layer.Tile({
              title: 'Hikebike',
              type: 'base',
              visible: false,
              source: new ol.source.XYZ({
                attributions: [
                  '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> © <a target="_blank" href="https://hikebikemap.com/">hikebike</a>',
                  ol.source.OSM.ATTRIBUTION
                ],
                url: 'https://tiles.wmflabs.org/hikebike/{z}/{x}/{y}.png'
                })
            }),
            new ol.layer.Tile({
              title: 'OpenCycleMap',
              type: 'base',
              visible: false,
              source: new ol.source.XYZ({
                attributions: [
                  '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> © <a target="_blank" href="https://www.opencyclemap.org/">OpenCycleMap</a>',
                  ol.source.OSM.ATTRIBUTION
                ],
                url: 'https://{a-c}.tile.thunderforest.com/cycle/{z}/{x}/{y}.png' +
              '?apikey=081ff7d83c0549c7a758fdd4df478f0f'
              })
            }),
            new ol.layer.Tile({
              title: 'CyclOSM',
              type: 'base',
              visible: false,
              source: new ol.source.XYZ({
                attributions: [
                  '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> - <a target="_blank" href="https://www.cyclosm.org/">CyclOSM</a>',
                  ol.source.OSM.ATTRIBUTION
                ],
                url: 'https://dev.{a-c}.tile.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png'
                })
            }),
            new ol.layer.Tile({
              title: 'OpenStreetMap',
              type: 'base',
              visible: false,
              source: new ol.source.XYZ({
                attributions: [
                  '<a target="_blank" href="https://openlayers.org/">OpenLayers</a>',
                  ol.source.OSM.ATTRIBUTION
                ],
                url: 'http://a.tile.openstreetmap.org/{z}/{x}/{y}.png'
                })
            }),
            	new ol.layer.Tile({
        title: 'Bing Aerial',
        type: 'base',
        visible: true,
      source: new ol.source.BingMaps({
        key: 'AudCyoI6al0eAZmQhwmI1IG9AOdGH8DHHk6PsiGta1faEACulxawFU9KV-XAvZ8f',
        imagerySet: 'Aerial'
      })
    }),
		new ol.layer.Group({
            title: 'Mapa Raster del IGN',
            type: 'base',
            combine: true,
            visible: false,
            layers: [
					new ol.layer.Tile({
         source: new ol.source.TileWMS(({
          preload: 4,
          url: "http://www.ign.es/wms-inspire/mapa-raster",
          attributions: '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> Teselas cartográficas cedidas por © <a target="_blank" href="https://www.ign.es/web/ign/portal">Instituto Geográfico Nacional de España</a>',
            params: {
              "LAYERS": "Fondo",
              "TILED": "true",
              "VERSION": "1.3.0"},
          })),
          opacity: 1.000000,
           }),
        new ol.layer.Tile({
         source: new ol.source.TileWMS(({
          preload: 4,
          url: "http://www.ign.es/wms-inspire/mapa-raster",
          attributions: '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> Teselas cartográficas cedidas por © <a target="_blank" href="https://www.ign.es/web/ign/portal">Instituto Geográfico Nacional de España</a>',
            params: {
              "LAYERS": "mtn_rasterizado",
              "TILED": "true",
              "VERSION": "1.3.0"},
          })),
          opacity: 1.000000,
           }),

		  ]
		}),
		new ol.layer.Group({
            title: 'Callejero IGN',
            type: 'base',
            combine: true,
            visible: false,
            layers: [ 
		new ol.layer.Tile({
         source: new ol.source.TileWMS(({
          preload: 4,
          url: "http://www.ign.es/wms-inspire/mapa-raster",
          attributions: '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> Teselas cartográficas cedidas por © <a target="_blank" href="https://www.ign.es/web/ign/portal">Instituto Geográfico Nacional de España</a>',
            params: {
              "LAYERS": "Fondo",
              "TILED": "true",
              "VERSION": "1.3.0"},
          })),
          opacity: 1.000000,
           }),
          new ol.layer.Tile({
          source: new ol.source.TileWMS(({
          url: "http://www.ign.es/wms-inspire/ign-base",
          attributions: '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> - CC BY 4.0 <a href="http://www.scne.es/">SCNE</a>',
            params: {
              "LAYERS": "IGNBaseTodo-nofondo",
              "TILED": "true",
              "VERSION": "1.0.0"},
          })),
          opacity: 1.000000,
           }),
		   		  ]
		}),
                         new ol.layer.Tile({
                source: new ol.source.WMTS(({
                  url: "http://www.ign.es/wmts/pnoa-ma",
                  attributions:  '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> Teselas cartográficas cedidas por © <a target="_blank" href="https://www.ign.es/web/ign/portal">Instituto Geográfico Nacional de España</a>',
                  "layer": "OI.OrthoimageCoverage",
                  matrixSet: 'EPSG:3857',
             			format: 'image/jpeg',
              		projection: projection_PNOA,
              		tileGrid: new ol.tilegrid.WMTS({
                    origin: ol.extent.getTopLeft(projectionExtent_PNOA),
                		resolutions: resolutions_PNOA,
                		matrixIds: matrixIds_PNOA
                  }),
                  style: 'default',
              		wrapX: true,
                  "VERSION": "1.0.0",
                })),
          title: "Satélite limpio",
          type: 'base',
          visible: false,
                opacity: 1.0,
              }),
                     new ol.layer.Group({
            title: 'Satélite y callejero',
            type: 'base',
            combine: true,
            visible: true,
            layers: [
              new ol.layer.Tile({
                source: new ol.source.WMTS(({
                  url: "http://www.ign.es/wmts/pnoa-ma",
                  attributions:  '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> Teselas cartográficas cedidas por © <a target="_blank" href="https://www.ign.es/web/ign/portal">Instituto Geográfico Nacional de España</a>',
                  "layer": "OI.OrthoimageCoverage",
                  matrixSet: 'EPSG:3857',
             			format: 'image/jpeg',
              		projection: projection_PNOA,
              		tileGrid: new ol.tilegrid.WMTS({
                    origin: ol.extent.getTopLeft(projectionExtent_PNOA),
                		resolutions: resolutions_PNOA,
                		matrixIds: matrixIds_PNOA
                  }),
                  style: 'default',
              		wrapX: true,
                  "VERSION": "1.0.0",
                })),
                opacity: 1.0,
              }),
               	new ol.layer.Tile({
                  source: new ol.source.TileWMS(({
                    url: "http://www.ign.es/wms-inspire/ign-base",
        						attributions: ' - CC BY 4.0 <a href="http://www.scne.es/">SCNE</a>',
        						params: {
        						"LAYERS": "IGNBaseOrto",
        						"TILED": "true",
        						"VERSION": "1.3.0"},
        						})),
        					opacity: 1.000000,
    							})
              ]
          }),
                      ]
        }),
        new ol.layer.Group({
          title: 'Complementos',
          layers: [
		      new ol.layer.Group({
            title: 'Curvas de Nivel',
            combine: true,
            visible: false,
            layers: [
          new ol.layer.Tile({
            source: new ol.source.TileWMS(({
            url: "http://servicios.idee.es/wms-inspire/mdt",
            attributions: 'CC BY 4.0 <a target="_blank" href="http://www.scne.es/productos.html#MDT5>SCNE</a>',
            params: {
                "LAYERS": "relieve",
                "TILED": "true",
                "VERSION": "1.3.0"},
              })),
            opacity: 0.50000,
            }),
          new ol.layer.Tile({
            source: new ol.source.TileWMS(({
            url: "http://servicios.idee.es/wms-inspire/mdt",
            attributions: ' ',
            params: {
                "LAYERS": "EL.ContourLine",
                "TILED": "true",
                "VERSION": "1.3.0"},
              })),
              opacity: 1.000000,
           }),
          ]
				}),
            new ol.layer.Group({
            title: 'Vértices Geodésicos',
            combine: true,
            visible: false,
            layers: [
             new ol.layer.Tile({
              source: new ol.source.TileWMS(({
                url: "http://www.ign.es/wms-inspire/redes-geodesicas?",
                attributions: '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> <a href="https://www.ign.es/web/ign/portal">© Instituto Geográfico Nacional de España</a>',
                params: {
                  "LAYERS": "RED_ROI",
                  "TILED": "true",
                  "VERSION": "1.3.0"},
              })),
              opacity: 1.000000,
            }),
                         new ol.layer.Tile({
              source: new ol.source.TileWMS(({
                url: "http://www.ign.es/wms-inspire/redes-geodesicas?",
                attributions: '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> <a href="https://www.ign.es/web/ign/portal">© Instituto Geográfico Nacional de España</a>',
                params: {
                  "LAYERS": "RED_ERGNSS",
                  "TILED": "true",
                  "VERSION": "1.3.0"},
              })),
              opacity: 1.000000,
            }),
                         new ol.layer.Tile({
              source: new ol.source.TileWMS(({
                url: "http://www.ign.es/wms-inspire/redes-geodesicas?",
                attributions: '<a target="_blank" href="https://openlayers.org/">OpenLayers</a> <a href="https://www.ign.es/web/ign/portal">© Instituto Geográfico Nacional de España</a>',
                params: {
                  "LAYERS": "RED_REGENTE",
                  "TILED": "true",
                  "VERSION": "1.3.0"},
              })),
              opacity: 1.000000,
            }),
                      ]
				}),
           new ol.layer.Tile({
     source: new ol.source.TileWMS(({
     url: "http://www.ign.es/wms-inspire/ngbe",
    attributions: 'CC BY 4.0 <a target="_blank" href="http://www.scne.es/productos.html#NGBE">SCNE</a>',
    params: {
                                "LAYERS": "GN.GeographicalNames",
                                "TILED": "true",
                                "VERSION": "2.0"},
                            })),
            title: "Nombres geográficos",
            visible: false,
            opacity: 1.000000,
                          }),
new ol.layer.Tile({
       source: new ol.source.TileWMS(({
    url: "http://wms.mapama.es/sig/Agua/RiosCompPfafs/wms.aspx?",
    attributions: '<a target="_blank" href="https://www.mapa.gob.es/es/"> @ Ministerio de Agricultura y Pesca, Alimentación y Medio Ambiente</a>',
    params: {
     "LAYERS": "HY.PhysicalWaters.Waterbodies",
     "TILED": "true",
     "VERSION": "1.3.0"},
    })),
      title: "Red Hidrográfica",
      visible: false,
      opacity: 1.000000, 
  
     }),
	new ol.layer.Tile({
              source: new ol.source.TileWMS(({
          		preload: 4,
              url: 'https://wms.mapama.gob.es/sig/Biodiversidad/ENP/wms.aspx?',
              attributions: [
                  '<a target="_blank" href="https://www.mapa.gob.es/es/"> @ Ministerio de Agricultura y Pesca, Alimentación y Medio Ambiente</a>'
                ],
                
              params: {
              "LAYERS": "PS.ProtectedSite",
              "TILED": "true",
              "VERSION": "1.3.0"},
          })),
                title: 'Espacios Naturales Protegidos',
              visible: false,
              opacity: 1.000000,
            }),
		          new ol.layer.Tile({
          source: new ol.source.TileWMS(({
  url: "https://wms.mapama.gob.es/sig/Biodiversidad/PropiedadMontes/wms.aspx?",
  params: {
          "LAYERS": "AM.ForestManagementArea",
          "TILED": "true",
          "VERSION": "1.3.0"},
          })),
        title: "Titularidad Montes",
        visible: false,
        opacity: 1.000000,
         }),
	 new ol.layer.Tile({
            source: new ol.source.TileWMS(({
            url: "http://www.madrid.org:80/geoserver/mam/SIGI_MA_CAMINO_SANTIAGO/ows?",
			attributions: '<a target="_blank" href="https://www.comunidad.madrid/actividades/2017/camino-santiago-madrid"> © Comunidad de Madrid</a>',
            params: {
                "LAYERS": "SIGI_MA_CAMINO_SANTIAGO",
                "VERSION": "1.3.0"},
                    })),
            title: "Camino de Santiago",
			visible: false,
            opacity: 1.000000,               
        }),
        new ol.layer.Tile({
            source: new ol.source.TileWMS(({
            url: "http://www.madrid.org/geoserver/mam/SIGI_MA_VIAS_PECUARIAS/wms",
			attributions: '<a target="_blank" href="https://www.comunidad.madrid/servicios/medio-rural/red-vias-pecuarias-comunidad-madrid">© Comunidad de Madrid</a>',
            params: {
                    "LAYERS": "SIGI_MA_VIAS_PECUARIAS",
                    "TILED": "true",
                    "VERSION": "1.3.0"},
                            })),
            title: "Vias Pecuarias Madrid",
            visible: false,
            opacity: 1.000000,
            }),
        new ol.layer.Tile({
			source: new ol.source.TileWMS(({
			url: "https://idem.madrid.org/geoidem/RedesTransporte/SIGI_V_MA_SENDAS_VERDES/wms",
			attributions: '<a target="_blank" href="https://www.comunidad.madrid/cultura/actividades-aire-libre-deporte/rutas-sendas">© Comunidad de Madrid</a>',
			params: {
				"LAYERS": "SIGI_V_MA_SENDAS_VERDES",
				"TILED": "true",
				"VERSION": "1.3.0"},
                            })),
            title: "Sendas Verdes Madrid",
            visible: false,
            opacity: 1.000000,
                          }),
                    new ol.layer.Group({
            title: 'PRUG P.N. Sierra de Guadarrama',
            combine: true,
            visible: false,
            layers: [
       new ol.layer.Tile({
            source: new ol.source.TileWMS(({
       url: "https://idecyl.jcyl.es/geoserver/am/wms",
                          attributions: '<a target="_blank" href="https://datosabiertos.jcyl.es/web/es/datos-abiertos-castilla-leon.html">©Junta de Castilla y León</a>',
    params: {
             "LAYERS": "am:ren_cyl_pnsg_zonific",
             "TILED": "true",
             "VERSION": "1.3.0"},
                            })),
    title: "PN Guadarrama: zonificación PRUG",
    opacity: 1.000000,                      
      }),
       new ol.layer.Tile({
           source: new ol.source.TileWMS(({
   url: "https://idecyl.jcyl.es/geoserver/am/wms",
    params: {
            "LAYERS": "am:ren_cyl_pnsg_actvs_vias_cicl",
            "TILED": "true",
            "VERSION": "1.3.0"},
            })),
          title: "PN Guadarrama: pistas bici",
          opacity: 1.000000,
           }),
      new ol.layer.Tile({
         source: new ol.source.TileWMS(({
     url: "https://idecyl.jcyl.es/geoserver/am/wms",
     params: {
             "LAYERS": "am:ren_cyl_pnsg_limites",
             "TILED": "true",
             "VERSION": "1.3.0"},
              })),
          title: "PN Guadarrama: límites PRUG",
          opacity: 1.000000,
           }),
         ]
     }),
            new ol.layer.Vector({
        visible: true,
        source: new ol.source.Vector({
            url: 'https://gist.githubusercontent.com/nanoflojo/3621967e03bb2031dbb4bb0e90fe3c6b/raw/7d96a28105c41716307712c84aafec40b618a3cd/FuentesAgua30Nov2024',
          format: new ol.format.GPX(),
        }),
				title: "Fuentes",
				visible: false,
                style: styleWater
      }),    
                      ]
}),
              gpxLayer
		  ],
              loadTilesWhileAnimating: true,
        view: view,
        controls: ol.control.defaults().extend([
            new ol.control.FullScreen(),
            new ol.control.ScaleLine({units: 'metric'}),
            new ol.control.ZoomSlider(),
        ]),
		  });
        var mouse_position = new ol.control.MousePosition({
    coordinateFormat: ol.coordinate.createStringXY(4),
    projection: 'EPSG:4326'
});
        map.addControl(mouse_position);
	     	dragAndDropInteraction.on('addfeatures', function(event) {
        var vectorSource = new ol.source.Vector({
          features: event.features
        });
        map.addLayer(new ol.layer.Vector({
          source: vectorSource,
          style: styleFunction
        }));
        map.getView().fit(
            vectorSource.getExtent(), /** @type {ol.Size} */ (map.getSize()));
      });
	  
	  //-------------popup GPX
      var popup = new Popup();
			map.addOverlay(popup);
      map.on('singleclick', function(evt) {
  if (evt.dragging) {
    return;
  }

    var info = document.getElementById('info');
  info.style.display = 'none';

    var target = document.getElementById('map');
  var pixel = map.getEventPixel(evt.originalEvent);
  var feature = map.forEachFeatureAtPixel(pixel, function(feature, layer) {
    return feature;
  });

  if (feature) {
    var text = feature.get('name') + feature.get('desc');
    info.innerHTML = text;
    info.style.display = 'block';
      popup.show(evt.coordinate, info);
  } else {
    popup.hide();
  }
});
  map.on('pointermove', (e) => {
  const pixel = map.getEventPixel(e.originalEvent);
  const hit = map.hasFeatureAtPixel(pixel);
  document.getElementById('map').style.cursor = hit ? 'pointer' : '';
});
//-------Geocoder
var geocoder = new Geocoder('nominatim', {
  provider: 'osm',
  lang: 'esp',
  placeholder: 'Buscar ...',
  limit: 5,
  debug: false,
  autoComplete: true,
  keepOpen: true
});
map.addControl(geocoder);
geocoder.on('addresschosen', function (evt) {
	console.info(evt);
  window.setTimeout(function () {
    popup.show(evt.coordinate, evt.address.formatted);
  }, 3000);
});

//-----------Boton Centrar
    var boton = document.createElement('button');
  boton.innerHTML = 'C';
  function onClick(id, callback){
    boton.addEventListener('click', callback);
  }
  onClick('boton-pan-center', function() {
    view.animate({
      center: ol.proj.transform([-3.9500000, 40.89000000], 'EPSG:4326', 'EPSG:3857'),
      zoom: 11,
      duration: 2000
    });
  });
  var elementoDiv = document.createElement('div');
  elementoDiv.className = 'boton-pan-center ol-unselectable ol-control';
  elementoDiv.appendChild(boton);
  var NuevoControl = new ol.control.Control({ element: elementoDiv });
   map.addControl(NuevoControl);
   
 //-----------Leyenda
  var boton1 = document.createElement('button');
  boton1.innerHTML = 'L';
  function onClick1(id, callback){
    boton1.addEventListener('click', callback);
  }
  onClick1('botonLeyenda', function toggleModal() {
modal.classList.toggle("mostrar-ventana");
},
function windowOnClick(event) {
if (event.target === modal) {
toggleModal();
}
});
  var modal = document.querySelector(".ventana");
  var trigger = document.querySelector(".trigger");
var closeButton = document.querySelector(".boton-cerrar");
function toggleModal() {
modal.classList.toggle("mostrar-ventana");
}
  var elementoDiv1 = document.createElement('trigger');
  elementoDiv1.className = 'botonLeyenda ol-unselectable ol-control';
  elementoDiv1.appendChild(boton1);
  var NuevoControl1 = new ol.control.Control({ element: elementoDiv1 });
  map.addControl(NuevoControl1);
  
    var layerSwitcher = new ol.control.LayerSwitcher({
        enableOpacitySliders: true
    });
    map.addControl(layerSwitcher);
	
document.getElementById('files').addEventListener('change', handleFileSelect, false);  
     closeButton.addEventListener("click", toggleModal);
	window.addEventListener("click", windowOnClick);
    </script>
	        <div style="line-height: 10px">
    <font size=2>
      <I>
        <br>(Alt + Shift + Arrastrar, gira el mapa.) 
   &nbsp; <img border="0" src="https://raw.githubusercontent.com/nanoflojo/MaparutasMTB/master/ArrowBlueOpenlayers160_OK.png" height="14" /> &nbsp;(Devuelve el mapa  a su orientación original.)
   &nbsp; <img border="0" src="https://raw.githubusercontent.com/nanoflojo/MaparutasMTB/master/IconoCentrar24.png" height="14" /> &nbsp;(Centra el mapa en el track.)<br />
        <br>(Pincha en la bandera del inicio de ruta para ver los enlaces a Wikiloc o Cicloide.)
      </I>
    </font>
   </div>
<p>Puedes ver tracks en formatos GPX y KML.</p> 
<p>Dispones de información complementaria sobre Fuentes, Espacios Naturales, Prug, Sendas Verdes, Vías Pecuarias, Vértices Geodésicos, Ríos, Camino de Santiago, Curvas de Nivel y Nombres Geográficos.</p>
<p><B>Legislación del Parque Nacional de la Sierra de Guadarrama</B></p>
<p>
<a target="_blank" href="http://www.bocm.es/boletin/CM_Orden_BOCM/2020/02/29/BOCM-20200229-1.PDF">BOCM 18/2020 Comunidad de Madrid</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a target="_blank" href="http://bocyl.jcyl.es/boletines/2019/05/24/pdf/BOCYL-D-24052019-1.pdf">BOCYL 16/2019 Castilla y León</a></p>
<B>Las capas de mapas disponibles son:</B>
<br>
<li>Vista Aérea, PNOA del IGN</li>
<li>Topográfico, MTN Raster del IGN</li>
<li>Callejero (SCNE)</li>
<li>Cyclemap</li>
<li>Open Street Map</li>
<li>Carreteras (Stamen)</li>
<li>Carreteras (Esri)</li>
<li>Topográfico (Esri)</li>
<li>Mapas Históricos del IGN</li>
<li>Cartográfia CEGET</li>
<li>Open Topo Map</li>
<li>Transporte Público (Memomaps)</li>
<li>Fondo elevciones (IGN)</li>
<br>
<B>Comparador de mapas históricos del Instituto Geográfico Nacional de España.</B><br>
Mapas de diversas épocas y fuentes cartográficas con información procedente del Archivo Topográfico del IGN. Acceso al <a target="_blank" href="https://www.ign.es/web/mapasantiguos/index.html">Visualizador de Mapas Antiguos del IGN</a>. Se compone de estas hojas:
<li>Hoja kilométrica, Cartografía catastral de rústica a escala 1:2.000, 1861-1870.</li>
<li>Minutas Cartográficas elaboradas en papel previos al Mapa Topográfico Nacional, realizados entre 1870 y 1950. Dibujados a escala 1:25.000, con información correspondiente a la escala 1:50.000.</li>
<li>Primera edición de los Mapas Topográficos Nacionales, MTN50 escala 1:50.000, recopilación de mapas finalizada en 1968 y MTN25 escala 1:25.000, concluida en 1975.</li>
<br>
<B>Centro Geográfico del Ejercito de Tierra.</B><br>
<li>Cartografía militar realizada por el Centro Geográfico del Ejército de Tierra (CEGET), Serie M682 a escala 1:100.000 y Serie M7814 a escala 1:50.000.</li>
<br>
<br>
<table CellPadding=0 CellSpacing=10 align="center">
  <tr>
	<td><a target="_blank" href="https://openlayers.org/"><img src=" https://raw.githubusercontent.com/nanoflojo/MaparutasMTB/master/logoOpenlayers.png" height="32"/></a></td>
		<td></td>
	<td><a target="_blank" href="https://wiki.openstreetmap.org/wiki/ES:P%C3%A1gina_principal "><img src=" https://raw.githubusercontent.com/nanoflojo/MaparutasMTB/master/Openstreetmap_logo.svg.png" height="32"/></a></td>
		<td></td>
	<td><a target="_blank" href="https://www.idee.es/web/guest/inicio"><img src=" https://raw.githubusercontent.com/nanoflojo/MaparutasMTB/master/LogoIDEE1.png" height="36"/></a></td>
		<td></td>
	<td><a target="_blank" href="https://www.ign.es/web/ign/portal"><img src=" https://raw.githubusercontent.com/nanoflojo/MaparutasMTB/master/LogoIGN1.jpg" height="36"/></a></td>
		<td></td>
	<td><a target="_blank" href="http://www.scne.es/inicio.html"><img src=" https://raw.githubusercontent.com/nanoflojo/MaparutasMTB/master/logoSCN1.png" height="38"/></a></td>
		<td></td>
	<td><a target="_blank" href="http://www.ejercito.mde.es/unidades/Madrid/ceget/index.html"><img src=" https://raw.githubusercontent.com/nanoflojo/MaparutasMTB/master/EscudoCEGET1.jpg" height="44"/></a></td>
		<td></td>
	<td><a target="_blank" href="https://memomaps.de/en/homepage/"><img src=" https://raw.githubusercontent.com/nanoflojo/MaparutasMTB/master/Memomaps-Logo.png" height="16"/></a></td>
		<td></td>
	<td><a target="_blank" href="https://www.esri.es/"><img src=" https://raw.githubusercontent.com/nanoflojo/MaparutasMTB/master/EsriLogo.jpg" height="32"/></a></td>
		<td></td>
	<td><a target="_blank" href="https://opentopomap.org/about"><img src=" https://raw.githubusercontent.com/nanoflojo/MaparutasMTB/master/OpenTopoLogo.png" height="32"/></a></td>
		<td></td>
	<td><a target="_blank" href="https://stamen.com/work/maps-stamen-com/"><img src=" https://raw.githubusercontent.com/nanoflojo/MaparutasMTB/master/LogoStamen.png" height="28"/></a></td>
  </tr>
</table>
<br> 
  </body>
</html>
